# P1160 - ESP32S3 PhotoPainter Open Firmware
This projects attempts to make an open sane firmware for the Waveshare Photopainter, specifically the esp32-s3 version.

## Stability
This is in heavy development, so expect unstable APIs for the time being.

## Philosophy
This will be an opinionated firmware, with the philosophies in mind:
- The primary objective for this firmware to be a simple photo frame
    - Other features will be added as time goes on, but the photo frame functionality comes first and foremost.
- For as much as possible, all heavy processing shall be done on the client rather on this firmware
    - For example, when uploading an image, I would rather have the client (script or web browser) do the heavy image compute, such as resizing and dithering, rather than on the ESP32. The compute has to happen *somewhere*, so might as well have it be on the beefier device.
- Local Only
    - We have enough IOT devices trying to phone home all the time. This firmware shall be designed to operate locally as much as possible.
    - Some future features may require an internet connection (such as NTP time or to auto-fetch images?), but this firmware shall be designed to require explicit permission and the ability to work without internet access
- No microphone usage
    - This goes with the point above on Local Only, but I will absolutely will not add features where the microphone must be enabled.
- No AI Content
    - I personally despise AI generated illustrations, thus I shall not enable it. While I can't, nor should, be able to disallow you to upload images generated by AI, such integration in this firmware will not be allowed.

# Hardware
- [Waveshare ESP-S3 PhotoPainter](https://www.waveshare.com/esp32-s3-photopainter.htm)

# API Docs
The web API docs can be found in [docs/openapi.yaml](docs/openapi.yaml).

# Unit Test
The folder `tests` contains a Python test script alongside a unit test C program for the API.
To run it, you first must build the firmware like normal, then run the make file. Right now only 1 target exists, `make test_apis`.

# Credits
A decent amount of this firmware comes from Waveshare's own example, especially on the eink initialization and pmic stuff.

The PMIC stuff, which was partially copied from Waveshare's example, is from the [XPowerLibs](https://github.com/lewisxhe/XPowersLib) library.

# Future Todo

- Add SD card storage and automatic image cycling
- Low power
- pmic rework
    - The PMIC uses the [XPowerLibs](https://github.com/lewisxhe/XPowersLib) library, which is what Waveshare's example "came with". I would like to make my own library.
- Moving eink.c into it's own component
    - Might have to make another component for the sane defines, such as u8
- Low-Level driving of SPI
    - Turns out that using esp-idf's spi library with DMA, the thing sets up the linked list required for the DMA per transaction: `spi_master.c->spi_device_polling_start()->spi_new_trans()->s_spi_prepare_data()->s_spi_dma_prepare_data()`
    As well as the entire SPI transaction settings. That among other things like always checking if a transaction is valid.
    I get it for a general purpose "any task can speak to spi" sort of setup and for a developer safe api, but given this is a controlled system it is a todo to just talk to the low-level drivers myself, as what it's doing is a bit much. Plus a learning opportunity for me. 
    This will be a last priority, as the saying goes "don't fix what ain't broken"

# Contributing
All contributions (unless it conflicts with the [philosophies](#Philosophy) above) are welcome! I will try to review them as soon as I can.

## Note on AI-Generated Code
While I do use ChatGPT in the my development, it is used as a pointer to information that I may not have otherwise known, and to generate based blocks. That said, the code it generates is not blindly copied-and-pasted without understanding it's function, and in most cases I write it out myself and look up the API docs manually for a full understanding.

I will not accept purely AI generated code, especially AI bot-generated PRs. The author must have a full understanding of their code.

# License
This project is licensed under GPLv3, except for the directory `components/xpowerlibs`, which is under the MIT license.